---
title: "Mystery Returns"
layout: default
output:
  md_document:
    variant: gfm
    preserve_yaml: TRUE
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "..") })
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.path = '../assets/img/Rmarkdown/')
install.packages(c("devtools", "tidyverse"), repos = "http://cran.us.r-project.org")
```
# An `nflfastR` mystery
Here's a quick little code chunk re: the (too?) large number of "returned" punts with 0 yard returns.

Install:
```{r, message=FALSE, results='hide'}
devtools::install_github("Puntalytics/puntr")
library(puntr)
library(tidyverse)
```
Filter to just returned punts:
```{r}
punts_2019 <- import_punts(2019)
returned_punts_2019 <- punts_2019 %>%
  filter(punt_out_of_bounds==0 &
           punt_downed==0 &
           punt_fair_catch==0 &
           touchback==0)
```
And finally, plot the distribution of returns:
```{r returndistributions}
ggplot(data = returned_punts_2019, mapping = aes(x = return_yards)) +
  geom_histogram(binwidth = 1) +
  theme_bw() +
  labs(title = "Distribution of returns on returned punts in 2019",
         subtitle = "Why all the punts with return = 0?",
         x="Return yards", caption="figure @ThePuntRunts | data @nflfastR")
```
Everything about this plot seems right, other than 100(!) more 0-yard returns than you'd expect. Our leading theories are:  
 
 - some fair catches are missing, meaning a fair caught punt is instead logged as "returned" punt with a 0-yard return (this seems most likely!). If this is the case, we'll probably just start assuming all 0-yard returns are fair catches and call it a day.  
 - some returns are missing, meaning e.g. a 50-yard punt with a 5-yard return gets mistakenly logged as a 45-yard punt with a 0-yard return.  
 - there's some filtering step beyond out-of-bounds, downed, fair catch, and touchback that we're forgetting, or we're doing this filtering improperly.  
  
It's also unclear to us where along the pipeline this discrepancy is most likely to have happened, anywhere from the scorekeeper going to the bathroom during a punt to improper filtering by us. And lastly, it's of course possible that this isn't an error at all, and there's just some football reason we're missing that there are so many 0-yard returns.  
  
In case you're curious (we were!) here's the same plot for all punts 1999-2019, which makes for a prettier distribution:
  
```{r returndistributionsallyears, echo=FALSE}
punts <- import_punts(1999:2019)
returned_punts <- punts %>%
  filter(punt_out_of_bounds==0 &
           punt_downed==0 &
           punt_fair_catch==0 &
           touchback==0)
ggplot(data = returned_punts, mapping = aes(x = return_yards)) +
  geom_histogram(binwidth = 1) +
  theme_bw() +
  labs(title = "Distribution of returns on returned punts, 1999-2019",
         subtitle = "Why all the punts with return = 0?",
         x="Return yards", caption="figure @ThePuntRunts | data @nflfastR")
```
  
In a last-ditch effort, we checked if some simple `str_detect`s could fix the problem; unfortunately, it seems like even this very wide net only snags a couple hundred punts, ~10% of the mystery.
```{r, include=TRUE}
punts %>% 
  filter(punt_out_of_bounds==0 & return_yards==0) %>%
  filter(desc %>% str_detect("bounds")) %>%
  mutate(gotcha = desc %>% str_extract("bounds")) %>%
  select(punt_out_of_bounds, gotcha)
```

```{r, include=TRUE}
punts %>% 
  filter(punt_downed==0) %>%
  filter(desc %>% str_detect("owned")) %>%
  mutate(gotcha = desc %>% str_extract("owned")) %>%
  select(punt_downed, gotcha)
```

```{r, include=TRUE}
punts %>% 
  filter(punt_fair_catch==0) %>%
  filter(desc %>% str_detect("air catch" ) | 
           desc %>% str_detect("air caught")) %>%
  mutate(gotcha = desc %>% str_extract("air c[:alpha:]+")) %>%
  select(punt_fair_catch, gotcha)
```

```{r, include=TRUE}
punts %>% 
  filter(touchback==0) %>%
  filter(desc %>% str_detect("ouchback" )) %>%
  mutate(gotcha = desc %>% str_extract("ouchback")) %>%
  select(punt_fair_catch, gotcha)
```
